<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>GlobLib: USB</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">GlobLib
   </div>
   <div id="projectbrief">HAL and API libraries for MCUs and hardware.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../../../doc/doxygen/html/index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../../../common/doc/doxygen/html/index.html"><span>Common</span></a></li>
      <li><a href="../../../../ATTINY13A/doc/doxygen/html/index.html"><span>ATTINY13A</span></a></li>
      <li><a href="index.html"><span>STM32F103CB</span></a></li>
      <li class="current"><a href="modules.html"><span>Modules</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__USB.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">USB<div class="ingroups"><a class="el" href="group__STM32F103CB.html">STM32F103CB</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>This module contains low level functions for USB interaction.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:stm32f103cb__usb_8h"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="stm32f103cb__usb_8h.html">stm32f103cb_usb.h</a></td></tr>
<tr class="memdesc:stm32f103cb__usb_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Header file for stm32f103cb USB. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga8204e6cd2ea4ae55baeba576aaeb0582"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__USB.html#ga8204e6cd2ea4ae55baeba576aaeb0582">USB_setup</a> (void)</td></tr>
<tr class="memdesc:ga8204e6cd2ea4ae55baeba576aaeb0582"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the USB device.  <a href="#ga8204e6cd2ea4ae55baeba576aaeb0582">More...</a><br /></td></tr>
<tr class="separator:ga8204e6cd2ea4ae55baeba576aaeb0582"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac75686b2d2590b4f6f7e3582908b44eb"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__USB.html#gac75686b2d2590b4f6f7e3582908b44eb">USB_update</a> (void)</td></tr>
<tr class="memdesc:gac75686b2d2590b4f6f7e3582908b44eb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update the USB peripheral.  <a href="#gac75686b2d2590b4f6f7e3582908b44eb">More...</a><br /></td></tr>
<tr class="separator:gac75686b2d2590b4f6f7e3582908b44eb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf56e06a2dbfa85005f6f1bb91732b96f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__USB.html#gaf56e06a2dbfa85005f6f1bb91732b96f">USB_put</a> (uint8_t byte)</td></tr>
<tr class="memdesc:gaf56e06a2dbfa85005f6f1bb91732b96f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Send a single byte on USB.  <a href="#gaf56e06a2dbfa85005f6f1bb91732b96f">More...</a><br /></td></tr>
<tr class="separator:gaf56e06a2dbfa85005f6f1bb91732b96f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaec367c5776ccc23b69284ce1aa69b434"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__USB.html#gaec367c5776ccc23b69284ce1aa69b434">USB_setGet</a> (void(*data_available)(uint8_t))</td></tr>
<tr class="memdesc:gaec367c5776ccc23b69284ce1aa69b434"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the function called when data is received on the USB.  <a href="#gaec367c5776ccc23b69284ce1aa69b434">More...</a><br /></td></tr>
<tr class="separator:gaec367c5776ccc23b69284ce1aa69b434"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga6efb295b738183028c575635cda46f32"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__USB.html#ga6efb295b738183028c575635cda46f32">USB_disconnect</a> (void)</td></tr>
<tr class="memdesc:ga6efb295b738183028c575635cda46f32"><td class="mdescLeft">&#160;</td><td class="mdescRight">Dissconnect the USB device from the HOST.  <a href="#ga6efb295b738183028c575635cda46f32">More...</a><br /></td></tr>
<tr class="separator:ga6efb295b738183028c575635cda46f32"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>This module contains low level functions for USB interaction. </p>
<p>The USB stack is taken from a modified version of OPENCM3 lib.</p>
<p>The USB module has a maximum data rate of 64kb / second.</p>
<p>When using the USB, USB_update must be called at at least 4KHz. Higher frequencies can be used, however this just causes unneccesary CPU usage.</p>
<p>The clock frequency for the MCU must be either internal 48MHz or external 72MHz for the USB to function.</p>
<dl class="section author"><dt>Author</dt><dd>Stuart Ianna </dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>June 2018 </dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>GNU GPLv3 </dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>Using the USB requires the USB device to be reset in the host OS every time the MCU is flashed. This is handled automatically in recipe "make flash". This requires ROOT access. OR the the the usb can be disconnected / reconnected. </dd></dl>
<dl class="bug"><dt><b><a class="el" href="bug.html#_bug000030">Bug:</a></b></dt><dd>When using the USB, the reset button on the MCU doesn't reset the USB peripheral. This means the only way to reset is to cycle power on the device. </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000015">Todo:</a></b></dt><dd></dd></dl>
<dl class="section user"><dt>Compilers</dt><dd><ul>
<li>arm-none-eabi-gcc (15:4.9.3+svn231177-1) 4.9.3 20150529 (prerelease)</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Minimum working example</dt><dd><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="stm32f103cb__core_8h.html">stm32f103cb_core.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string11.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//This gets called when new data is available</span></div><div class="line"><span class="keywordtype">void</span> data_available(uint8_t byte);</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>){</div><div class="line"></div><div class="line">    <span class="comment">//Clock speed needs to be 48MHz or greater</span></div><div class="line">    <a class="code" href="group__CLOCK.html#ga1c0fb75e4c7de12f534ad46014d35611">CLOCK_setSpeed</a>(<a class="code" href="group__CLOCK.html#gga40243a242aa3fc9a23d8555457058312aae437411fac0d0b39e98fdc40b0a6e6a">CLOCK_EX_8_OUT_72</a>);</div><div class="line"></div><div class="line">    <span class="comment">//Setup the USB</span></div><div class="line">    <a class="code" href="group__USB.html#ga8204e6cd2ea4ae55baeba576aaeb0582">USB_setup</a>();</div><div class="line"></div><div class="line">    <span class="comment">//Target received data to function</span></div><div class="line">    <a class="code" href="group__USB.html#gaec367c5776ccc23b69284ce1aa69b434">USB_setGet</a>(&amp;data_available);</div><div class="line"></div><div class="line">    <span class="comment">//USB MUST be refreshed via a timer at at least 4KHz (higher rate = more CPU)</span></div><div class="line">    <a class="code" href="group__SYSTICK.html#gaafba91666a34a65bf0e02d20a85aca0a">SYSTICK_setup</a>(250,&amp;<a class="code" href="group__USB.html#gac75686b2d2590b4f6f7e3582908b44eb">USB_update</a>);</div><div class="line"></div><div class="line">    <span class="comment">//Set the string output to USB</span></div><div class="line">    STRING11_setOutput(&amp;<a class="code" href="group__USB.html#gaf56e06a2dbfa85005f6f1bb91732b96f">USB_put</a>);</div><div class="line"></div><div class="line">    <span class="comment">//Print message</span></div><div class="line">    printl(<span class="stringliteral">&quot;USB test. Echo characters to terminal.&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">//Done</span></div><div class="line">    <span class="keywordflow">while</span>(1);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> data_available(uint8_t byte){</div><div class="line"></div><div class="line">    print((<span class="keywordtype">char</span>)byte);</div><div class="line">}</div></div><!-- fragment --> </dd></dl>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ga6efb295b738183028c575635cda46f32"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USB_disconnect </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Dissconnect the USB device from the HOST. </p>
<p>This is also called internally at the start of <a class="el" href="group__USB.html#ga8204e6cd2ea4ae55baeba576aaeb0582" title="Initialize the USB device. ">USB_setup()</a>. This allows a software reset to register with the host and the USB to be reconfigured. </p>

<p>Definition at line <a class="el" href="stm32f103cb__usb_8c_source.html#l00271">271</a> of file <a class="el" href="stm32f103cb__usb_8c_source.html">stm32f103cb_usb.c</a>.</p>

</div>
</div>
<a class="anchor" id="gaf56e06a2dbfa85005f6f1bb91732b96f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USB_put </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>byte</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Send a single byte on USB. </p>
<p>This function actually loads the byte into the internal software buffer. The byte is send internally in <a class="el" href="group__USB.html#gac75686b2d2590b4f6f7e3582908b44eb" title="Update the USB peripheral. ">USB_update()</a>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">byte</td><td>The byte to send (add to buffer). </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="stm32f103cb__usb_8c_source.html#l00340">340</a> of file <a class="el" href="stm32f103cb__usb_8c_source.html">stm32f103cb_usb.c</a>.</p>

</div>
</div>
<a class="anchor" id="gaec367c5776ccc23b69284ce1aa69b434"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USB_setGet </td>
          <td>(</td>
          <td class="paramtype">void(*)(uint8_t)&#160;</td>
          <td class="paramname"><em>data_available</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the function called when data is received on the USB. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">data_available</td><td>Funtion pointer to the function to be called </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="stm32f103cb__usb_8c_source.html#l00309">309</a> of file <a class="el" href="stm32f103cb__usb_8c_source.html">stm32f103cb_usb.c</a>.</p>

</div>
</div>
<a class="anchor" id="ga8204e6cd2ea4ae55baeba576aaeb0582"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USB_setup </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the USB device. </p>
<p>This must be called before any other API feature is used.</p>
<p>The clock must be &gt; 48Mhz This function has a internal delay for the USB to setup (approx 0.3s); </p>

<p>Definition at line <a class="el" href="stm32f103cb__usb_8c_source.html#l00287">287</a> of file <a class="el" href="stm32f103cb__usb_8c_source.html">stm32f103cb_usb.c</a>.</p>

</div>
</div>
<a class="anchor" id="gac75686b2d2590b4f6f7e3582908b44eb"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USB_update </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update the USB peripheral. </p>
<p>This must be call at at least 4kHz.</p>
<p>This function handles control requests from the host and sends any data waiting in the internal software buffer. </p>

<p>Definition at line <a class="el" href="stm32f103cb__usb_8c_source.html#l00318">318</a> of file <a class="el" href="stm32f103cb__usb_8c_source.html">stm32f103cb_usb.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
